---

- name: Reproducer Play
  hosts: "{{ cifmw_target_host | default('localhost') }}"
  gather_facts: true
  pre_tasks:
    - name: Ensure we pass needed parameter
      ansible.builtin.assert:
        that:
          - cifmw_use_libvirt is defined
          - cifmw_use_libvirt | bool
        msg: >-
          Please ensure you pass "cifmw_use_libvirt: true" to the
          deployment!
        quiet: true

    - name: Gather OS facts
      ansible.builtin.setup:
        gather_subset:
          - "!all"
          - "!min"
          - "distribution"
    - name: Setup repositories via rhos-release if needed
      tags:
        - packages
      when:
        - ansible_facts['distribution'] == 'RedHat'
        - cifmw_reproducer_hp_rhos_release | bool
      vars:
        cifmw_repo_setup_output: /etc/yum.repos.d
        cifmw_repo_setup_rhos_release_args: "rhel"
      ansible.builtin.import_role:
        name: repo_setup
        tasks_from: rhos_release.yml

  roles:
    - role: ci_setup
    - role: reproducer
