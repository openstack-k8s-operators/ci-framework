---
- name: List packages to install
  tags:
    - bootstrap
    - packages
  ansible.builtin.debug:
    var: cifmw_ci_setup_packages

- name: Install needed packages  # noqa: package-latest
  become: true
  tags:
    - bootstrap
    - packages
  ansible.builtin.package:
    name: "{{ cifmw_ci_setup_packages }}"
    state: latest

- name: Install openshift client
  tags:
    - bootstrap
    - packages
  block:
    - name: Gather version of openshift client if it exists
      register: oc_version
      environment:
        PATH: "{{ cifmw_path }}"
      ansible.builtin.command:
        cmd: "oc version -o yaml"

    - name: Check if version of openshift client is supported
      vars:
        oc_version_data: "{{ oc_version.stdout | from_yaml }}"
        oc_major_version: "{{ oc_version_data.releaseClientVersion | split('.') | first }}"
      ansible.builtin.assert:
        that:
          - oc_major_version | int >= cifmw_ci_setup_openshift_minimum_version
  rescue:
    - name: Ensure openshift client install path is present
      ansible.builtin.file:
        path: "{{ cifmw_ci_setup_openshift_client_install_path }}"
        state: directory
        mode: "0755"

    - name: Install openshift client
      ansible.builtin.unarchive:
        src: "{{ cifmw_ci_setup_openshift_client_download_uri }}/{{ cifmw_ci_setup_openshift_client_version }}/openshift-client-linux.tar.gz"
        dest: "{{ cifmw_ci_setup_openshift_client_install_path }}"
        remote_src: true
        mode: "0755"
        creates: "{{ cifmw_ci_setup_openshift_client_install_path }}/oc"

- name: Inject oc completion in local profile
  block:
    - name: Create completion file
      ansible.builtin.shell:  # noqa: risky-shell-pipe
        cmd: >-
          {{ cifmw_ci_setup_openshift_client_install_path }} completion bash |
          tee -a ~/.oc_completion
        creates: "{{ ansible_user_dir }}/.oc_completion"

    - name: Source completion from within .bashrc
      ansible.builtin.blockinfile:
        path: "{{ ansible_user_dir }}/.bashrc"
        block: |-
          if [ -f ~/.oc_completion ]; then
            source ~/.oc_completion
          fi
