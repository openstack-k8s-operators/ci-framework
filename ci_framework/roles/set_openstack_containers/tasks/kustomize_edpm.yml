---
- name: Make EDPM manifests directory exists
  ansible.builtin.file:
    path: "{{ cifmw_set_openstack_containers_basedir }}/artifacts/manifests/kustomizations/dataplane"
    state: directory
    recurse: true

- name: Construct container registry
  ansible.builtin.set_fact:
    _container_registry: "{{ cifmw_set_openstack_containers_registry }}/{{ cifmw_set_openstack_containers_namespace }}"

- name: Construct container url
  ansible.builtin.set_fact:
    _container_url: "{{ _container_registry }}/{{ cifmw_set_openstack_containers_prefix }}"

- name: Create EDPM Container CR customization
  ansible.builtin.copy:
    dest: "{{ cifmw_set_openstack_containers_basedir }}/artifacts/manifests/kustomizations/dataplane/100-kustomization.yaml"
    content: |-
      apiVersion: kustomize.config.k8s.io/v1beta1
      kind: Kustomization
      resources:
      namespace: {{ cifmw_install_yamls_defaults.NAMESPACE }}
      patches:
      - target:
          kind: OpenStackDataPlaneNodeSet
        patch: |-

          - op: add
            path: /spec/nodeTemplate/ansible/ansibleVars/edpm_ovn_controller_agent_image
            value: {{ _container_url }}-ovn-controller:{{ cifmw_set_openstack_containers_tag }}

          - op: add
            path: /spec/nodeTemplate/ansible/ansibleVars/edpm_iscsid_image
            value: {{ _container_url }}-iscsid:{{ cifmw_set_openstack_containers_tag }}

          - op: add
            path: /spec/nodeTemplate/ansible/ansibleVars/edpm_logrotate_crond_image
            value: {{ _container_url }}-cron:{{ cifmw_set_openstack_containers_tag }}

          - op: add
            path: /spec/nodeTemplate/ansible/ansibleVars/edpm_nova_compute_image
            value: {{ _container_url }}-nova-compute:{{ cifmw_set_openstack_containers_tag }}

          - op: add
            path: /spec/nodeTemplate/ansible/ansibleVars/edpm_libvirt_image
            value: {{ _container_url }}-nova-libvirt:{{ cifmw_set_openstack_containers_tag }}

          - op: add
            path: /spec/nodeTemplate/ansible/ansibleVars/edpm_neutron_metadata_agent_image
            value: {{ _container_url }}-neutron-metadata-agent-ovn:{{ cifmw_set_openstack_containers_tag }}

          - op: add
            path: /spec/nodeTemplate/ansible/ansibleVars/edpm_neutron_ovn_agent_image
            value: {{ _container_url }}-neutron-ovn-agent:{{ cifmw_set_openstack_containers_tag }}

          - op: add
            path: /spec/nodeTemplate/ansible/ansibleVars/edpm_ovn_bgp_agent_image
            value: {{ _container_url }}-ovn-bgp-agent:{{ cifmw_set_openstack_containers_tag }}

          - op: add
            path: /spec/nodeTemplate/ansible/ansibleVars/edpm_neutron_dhcp_image
            value: {{ _container_url }}-neutron-dhcp-agent:{{ cifmw_set_openstack_containers_tag }}

          - op: add
            path: /spec/nodeTemplate/ansible/ansibleVars/edpm_neutron_sriov_image
            value: {{ _container_url }}-neutron-sriov-agent:{{ cifmw_set_openstack_containers_tag }}

          - op: add
            path: /spec/nodeTemplate/ansible/ansibleVars/edpm_frr_image
            value: {{ _container_url }}-frr:{{ cifmw_set_openstack_containers_tag }}

          - op: add
            path: /spec/nodeTemplate/ansible/ansibleVars/edpm_multipathd_image
            value: {{ _container_url }}-multipathd:{{ cifmw_set_openstack_containers_tag }}
