---
- name: Create a temporary file to hold the device configuration
  ansible.builtin.tempfile:
    state: file
    prefix: "{{ _vm_name }}_device_"
  register: vm_devices_file

- name: Copy the device configuration requested for the VM to a temporary file
  ansible.builtin.copy:
    content: "{{ _vm_device }}"
    dest: "{{ vm_devices_file.path }}"
    mode: '0660'

- name: Attach the device configuration to the VM
  ansible.builtin.shell:
    cmd: >-
      set -o pipefail;
      virsh -c qemu:///system attach-device {{ _vm_name }} {{ vm_devices_file.path }}
      --persistent;
