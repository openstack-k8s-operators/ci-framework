---
- name: Converge
  hosts: all
  gather_facts: false

  vars_files:
    - vars.yaml
  vars:
    # Vars required by prepare_overcloud.yml
    cifmw_libvirt_manager_images_path: /tmp/images
    cifmw_libvirt_manager_image_name: centos-stream-9.qcow2
    cifmw_adoption_osp_deploy_repos: []
    cifmw_adoption_source_scenario_path: "."
    cifmw_basedir: "{{ playbook_dir }}"
    ansible_user_dir: "{{ lookup('env', 'HOME') }}"

  tasks:
    - name: Gather stack nodes and facts
      ansible.builtin.include_tasks: ../../tasks/gather_stack_nodes.yml
      loop: "{{ stacks }}"
      loop_control:
        loop_var: _stack

    - name: Store result for verification as persistent fact
      ansible.builtin.set_fact:
        tripleo_nodes_stack: "{{ _tripleo_nodes_stack }}"
        cacheable: true
