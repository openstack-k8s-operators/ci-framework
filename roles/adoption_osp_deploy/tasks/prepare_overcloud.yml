---
# Copyright Red Hat, Inc.
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

- name: Gather ansible_user_id from undercloud
  delegate_to: "osp-undercloud-0"
  ansible.builtin.setup:
    gather_subset:
      - user_id
      - user_dir

- name: Prepare enviornment for 17.1 overcloud deployment
  block:
    - name: Gather stack nodes and facts
      ansible.builtin.include_tasks: gather_stack_nodes.yml

    - name: Ensure overcloud vms are started
      vars:
        _cifmw_libvirt_manager_layout: >-
          {%- set layout = {'vms': {}} -%}
          {%- for group in _stack.stack_nodes -%}
          {%- set _ = layout['vms'].update({
            group: {'start': true, 'disk_file_name': 'dummy'}})
          -%}
          {%- endfor -%}
          {{ layout }}
        cifmw_libvirt_manager_all_vms: >-
          {%- set vms = {} -%}
          {%- for group in _stack.stack_nodes -%}
          {%- for vm in _vm_groups[group] -%}
            {%- set _ = vms.update({vm: group}) -%}
          {%- endfor -%}
          {%- endfor -%}
          {{ vms }}
        ansible_libvirt_pools: {}
      ansible.builtin.include_role:
        name: "libvirt_manager"
        tasks_from: "start_vms.yml"
        apply:
          delegate_to: "{{ cifmw_target_host | default('localhost') }}"

    - name: Ensure needed logins
      ansible.builtin.include_tasks: login_registries.yml
      args:
        apply:
          delegate_to: "{{ _vm }}"
      loop: "{{ _tripleo_nodes_stack[_overcloud_name] }}"
      loop_control:
        loop_var: _vm
        pause: 1

    - name: Ensure repos are setup in overcloud nodes
      delegate_to: "{{ _vm }}"
      become: true
      community.general.rhsm_repository:
        name: "{{ cifmw_adoption_osp_deploy_repos }}"
        state: enabled
      loop: "{{ _tripleo_nodes_stack[_overcloud_name] }}"
      loop_control:
        loop_var: _vm
        pause: 1

    - name: Copy network data file if it's not a template
      when: _network_data_extension != '.j2'
      delegate_to: "osp-undercloud-0"
      ansible.builtin.copy:
        src: "{{ _network_data_file }}"
        dest: "{{ _network_data_file_dest }}"
        mode: "0644"

    - name: Template network data file if needed
      when: _network_data_extension == '.j2'
      delegate_to: "osp-undercloud-0"
      vars:
        cloud_domain: >-
          {{
            cifmw_adoption_osp_deploy_scenario.cloud_domain
          }}
      ansible.builtin.template:
        src: "{{ _network_data_file }}"
        dest: "{{ _network_data_file_dest }}"
        mode: "0644"

    - name: Ensure network_provision_out file does not exist
      delegate_to: "osp-undercloud-0"
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/{{ _network_provision_output }}"
        state: absent

    - name: Provision openstack networks
      delegate_to: "osp-undercloud-0"
      vars:
        _network_provision_cmd: >-
          openstack overcloud network provision
          --output {{ ansible_user_dir }}/{{ _network_provision_output }}
          {{ _network_data_file_dest }}
      cifmw.general.ci_script:
        chdir: "{{ ansible_user_dir }}"
        output_dir: "{{ cifmw_basedir }}/artifacts"
        script: "{{ _source_cmd }}; {{ _network_provision_cmd }}"

    - name: Copy vips data file
      delegate_to: "osp-undercloud-0"
      ansible.builtin.copy:
        src: "{{ _vips_data_file }}"
        dest: "{{ _vips_data_file_dest }}"
        mode: "0644"

    - name: Ensure vips_provision_out file does not exist
      delegate_to: "osp-undercloud-0"
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/{{ _vips_provision_output }}"
        state: absent

    - name: Provision virtual ips
      delegate_to: "osp-undercloud-0"
      vars:
        _vip_provision_cmd: >-
          openstack overcloud network vip provision
          --stack {{ _overcloud_name }}
          --output {{ansible_user_dir}}/{{ _vips_provision_output }}
          {{ _vips_data_file_dest }}
      cifmw.general.ci_script:
        output_dir: "{{ cifmw_basedir }}/artifacts"
        script: "{{ _source_cmd }}; {{ _vip_provision_cmd }}"

    - name: Create tripleo ansible inventory
      when: not (cifmw_adoption_osp_deploy_bgp | bool)
      delegate_to: "osp-undercloud-0"
      ansible.builtin.template:
        src: "tripleo-ansible-inventory.yaml.j2"
        dest: "{{ ansible_user_dir }}/overcloud-deploy/{{ _overcloud_name }}/tripleo-ansible-inventory.yaml"
        mode: "0644"

    - name: Create tripleo ansible inventory (BGP)
      when: cifmw_adoption_osp_deploy_bgp | bool
      delegate_to: "osp-undercloud-0"
      ansible.builtin.template:
        src: "tripleo-ansible-inventory_bgp.yaml.j2"
        dest: "{{ ansible_user_dir }}/overcloud-deploy/{{ _overcloud_name }}/tripleo-ansible-inventory.yaml"
        mode: "0644"

    - name: Ensure os-net-config and openvswitch is installed in overcloud nodes
      become: true
      delegate_to: "{{ overcloud_vm }}"
      ansible.builtin.dnf:
        name:
          - os-net-config
          - openvswitch
        state: present
      loop: "{{ _tripleo_nodes_stack[_overcloud_name] }}"
      loop_control:
        loop_var: overcloud_vm

    - name: Ensure os-net-config folder exists in overcloud nodes
      become: true
      delegate_to: "{{ overcloud_vm }}"
      ansible.builtin.file:
        path: "/etc/os-net-config"
        state: directory
        mode: '0755'
      loop: "{{ _tripleo_nodes_stack[_overcloud_name] }}"
      loop_control:
        loop_var: overcloud_vm

    - name: Generate os-net-config file for overcloud nodes
      become: true
      delegate_to: "{{ overcloud_vm }}"
      vars:
        _node_net: "{{ cifmw_networking_env_definition.instances[overcloud_vm] }}"
        _ctlplane_ip: "{{ _node_net.networks.ctlplane[ip_version|default('ip_v4')] }}"
        _ctlplane_net: "{{ cifmw_networking_env_definition.networks.ctlplane }}"
        _dns_server: "{{ _ctlplane_net.[dns_version|default('dns_v4')] }}"
        _gateway_ip: "{{ _ctlplane_net[gw_version|default('gw_v4')] }}"
        _interface_mtu: "{{ _node_net.networks.ctlplane.mtu }}"
        _ctlplane_cidr: "{{ _node_net.networks.ctlplane[prefix_length_version|default('prefix_length_v4')] }}"
      ansible.builtin.template:
        src: "os_net_config_overcloud.yml.j2"
        dest: /etc/os-net-config/tripleo_config.yaml
        mode: "0644"
      loop: "{{ _tripleo_nodes_stack[_overcloud_name] }}"
      loop_control:
        loop_var: overcloud_vm
      when: not (cifmw_adoption_osp_deploy_bgp | bool)

    - name: Generate os-net-config file for overcloud nodes (bgp)
      become: true
      delegate_to: "{{ overcloud_vm }}"
      vars:
        _node_net: "{{ cifmw_networking_env_definition.instances[overcloud_vm] }}"
        _dns_server: "{{ _ctlplane_net.[dns_version|default('dns_v4')] }}"
        _interface_mtu: 1500
        vms:
          osp-r0-compute-0:
            ctlplane: '192.168.122.100'
            left: '100.64.0.2'
            right: '100.65.0.2'
            main: '99.99.0.7'
            main6: 'f00d:f00d:f00d:f00d:f00d:f00d:f00d:0004'
          osp-r0-compute-1:
            ctlplane: '192.168.122.101'
            left: '100.64.0.6'
            right: '100.65.0.6'
            main: '99.99.0.8'
            main6: 'f00d:f00d:f00d:f00d:f00d:f00d:f00d:0005'
          osp-r1-compute-0:
            ctlplane: '192.168.123.105'
            left: '100.64.1.2'
            right: '100.65.1.2'
            main: '99.99.1.7'
            main6: 'f00d:f00d:f00d:f00d:f00d:f00d:f00d:0006'
          osp-r1-compute-1:
            ctlplane: '192.168.123.106'
            left: '100.64.1.6'
            right: '100.65.1.6'
            main: '99.99.1.8'
            main6: 'f00d:f00d:f00d:f00d:f00d:f00d:f00d:0007'
          osp-r2-compute-0:
            ctlplane: '192.168.124.110'
            left: '100.64.2.2'
            right: '100.65.2.2'
            main: '99.99.2.7'
            main6: 'f00d:f00d:f00d:f00d:f00d:f00d:f00d:0008'
          osp-r2-compute-1:
            ctlplane: '192.168.124.111'
            left: '100.64.2.6'
            right: '100.65.2.6'
            main: '99.99.2.8'
            main6: 'f00d:f00d:f00d:f00d:f00d:f00d:f00d:0009'
          osp-r0-controller-0:
            ctlplane: '192.168.122.140'
            left: '100.64.0.26'
            right: '100.65.0.26'
            main: '99.99.0.9'
            main6: 'f00d:f00d:f00d:f00d:f00d:f00d:f00d:0001'
          osp-r1-controller-0:
            ctlplane: '192.168.123.142'
            left: '100.64.1.26'
            right: '100.65.1.26'
            main: '99.99.1.9'
            main6: 'f00d:f00d:f00d:f00d:f00d:f00d:f00d:0002'
          osp-r2-controller-0:
            ctlplane: '192.168.124.144'
            left: '100.64.2.26'
            right: '100.65.2.26'
            main: '99.99.2.9'
            main6: 'f00d:f00d:f00d:f00d:f00d:f00d:f00d:0003'
      ansible.builtin.template:
        src: "os_net_config_overcloud_bgp.yml.j2"
        dest: /etc/os-net-config/tripleo_config.yaml
        mode: "0644"
      loop: "{{ _tripleo_nodes_stack[_overcloud_name] }}"
      loop_control:
        loop_var: overcloud_vm
      when: cifmw_adoption_osp_deploy_bgp | bool

    - name: Configure network interfaces for overcloud nodes
      become: true
      delegate_to: "{{ overcloud_vm }}"
      ansible.builtin.command:
        cmd: "os-net-config -c /etc/os-net-config/tripleo_config.yaml"
      loop: "{{ _tripleo_nodes_stack[_overcloud_name] }}"
      loop_control:
        loop_var: overcloud_vm

    - name: Slurp undercloud public key for ssh access to overcloud nodes
      delegate_to: "osp-undercloud-0"
      ansible.builtin.slurp:
        path: "{{ ansible_user_dir }}/.ssh/id_rsa.pub"
      register: undercloud_ssh_pub

    - name: Place undercloud public key in authorized_keys for zuul and root
      delegate_to: "{{ overcloud_vm }}"
      ansible.posix.authorized_key:
        user: "{{ ansible_user_id }}"
        key: "{{ undercloud_ssh_pub['content'] | b64decode | trim }}"
      loop: "{{ _tripleo_nodes_stack[_overcloud_name] }}"
      loop_control:
        loop_var: overcloud_vm

    - name: Apply patch to increase cinder-api timeout (bgp)
      when: cifmw_adoption_osp_deploy_bgp | bool
      delegate_to: "osp-undercloud-0"
      become: true
      block:
        - name: Ensure patch package is installed in undercloud
          ansible.builtin.dnf:
            name: patch
            state: present

        - name: BGP workaround apply patch
          ansible.posix.patch:
            src: "{{ item.patch_file }}"
            dest: "{{ item.dest_file }}"
            strip: 1
          loop:
            - patch_file: files/bgp-tht-cinder-patch
              dest_file: /usr/share/openstack-tripleo-heat-templates/deployment/cinder/cinder-api-container-puppet.yaml
            - patch_file: files/bgp-tht-frr-patch
              dest_file: /usr/share/openstack-tripleo-heat-templates/deployment/frr/frr-container-ansible.yaml
