---
# Copyright Red Hat, Inc.
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

- name: Deploy 17.1 overcloud
  vars:
    _roles_file: >-
      {{
        [cifmw_adoption_source_scenario_path,
         _adoption_source_scenario.overcloud.roles_file
        ] | path_join
      }}
    _roles_file_name: "{{ _roles_file | basename }}"
    _roles_file_dest: "{{ ansible_user_dir }}/{{ _roles_file_name }}"
    _network_data_file: >-
      {{
        [cifmw_adoption_source_scenario_path,
         _adoption_source_scenario.overcloud.network_data_file
        ] | path_join
      }}
    _network_data_file_name: "{{ _network_data_file | basename }}"
    _network_data_file_dest: "{{ ansible_user_dir }}/{{ _network_data_file_name }}"
    _overcloud_args: >-
      {{
        _adoption_source_scenario.overcloud.args | join(' ')
      }}
    _overcloud_vars: >-
      {{
        _adoption_source_scenario.overcloud.vars | join(' -e ')
      }}
    _overcloud_name: >-
      {{
        _adoption_source_scenario.overcloud.stackname |
        default('overcloud')
      }}
  block:
    - name: Copy network data file
      delegate_to: "osp-undercloud-0"
      ansible.builtin.copy:
        src: "{{ _network_data_file }}"
        dest: "{{ _network_data_file_dest }}"

    - name: Copy roles file
      delegate_to: "osp-undercloud-0"
      ansible.builtin.copy:
        src: "{{ _roles_file }}"
        dest: "{{ _roles_file_dest }}"

    - name: Run overcloud deploy
      delegate_to: "osp-undercloud-0"
      vars:
        _overcloud_deploy_cmd: >-
          openstack overcloud deploy
          --stack {{ _overcloud_name }}
          {{ _overcloud_args }}
          --roles-file {{ _roles_file_dest }}
          -n {{ _network_data_file_dest }}
          --ntp-server {{ cifmw_adoption_osp_deploy_ntp_server }}
          -e {{ _overcloud_vars }}
          -e {{ ansible_user_dir }}/containers-prepare-parameters.yaml
          -e {{ ansible_user_dir }}/config-download.yaml
          -e {{ ansible_user_dir }}/vips_provision_out.yaml
          -e {{ ansible_user_dir }}/network_provision_out.yaml
        _source_cmd: "source {{ ansible_user_dir }}/stackrc"
      cifmw.general.ci_script:
        chdir: "{{ ansible_user_dir }}"
        output_dir: "{{ cifmw_basedir }}/artifacts"
        script: "{{ _source_cmd }}; {{ _overcloud_deploy_cmd }}"
