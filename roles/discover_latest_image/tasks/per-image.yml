---
# Copyright Red Hat, Inc.
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

- name: Ensure the current image dict entry has the expected schema
  ansible.builtin.assert:
    that:
      - _current_image.value.base_url is defined
      - _current_image.value.qcow_prefix is defined
      - _current_image.value.images_file is defined
    fail_msg: >-
      The image discovery request dict's {{ _current_image.key }} entry is
      missing at least one expected value. The following is undefined:
      {{ "base_url" if _current_image.value.base_url is undefined else "" }}
      {{ "qcow_prefix" if _current_image.value.qcow_prefix is undefined else "" }}
      {{ "images_file" if _current_image.value.images_file is undefined else "" }}

- name: Get latest image for the current entry
  register: discovered_image
  cifmw.general.discover_latest_image:
    url: "{{ _current_image.value.base_url }}"
    image_prefix: "{{ _current_image.value.qcow_prefix }}"
    images_file: "{{ _current_image.value.images_file }}"

- name: Append the current return value to the discovered images dict
  ansible.builtin.set_fact:
    cifmw_discovered_images_dict: >-
      {{ cifmw_discovered_images_dict | default({}) |
      combine({_current_image.key: discovered_image.data}) }}
    cacheable: true
