---
# Copyright Red Hat, Inc.
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

- name: Include common prerequisites
  ansible.builtin.include_tasks: common_prerequisites.yml

- name: "BS-04: Install yamls make target"
  when: cifmw_architecture_scenario is undefined
  block:
    - name: Check if install_yamls is already configured
      ansible.builtin.include_tasks: checks/check_install_yamls_configured.yml

    - name: Check if CI setup is done (prerequisite)
      ansible.builtin.include_tasks: checks/check_ci_setup_done.yml

    - name: Verify prerequisites
      when: not _cifmw_setup_bootstrap_ci_packages_installed
      ansible.builtin.fail:
        msg: |
          BS-04 requires CI setup first (needs git, make, python packages).
          Either run BS-03 (ci_setup.yml) or install required packages manually.
          Required packages: git-core, bash-completion, make, tmux, python3-pip

    - name: Prepare install_yamls make targets
      when: not _cifmw_setup_bootstrap_install_yamls_targets_generated
      ansible.builtin.include_role:
        name: install_yamls
        apply:
          tags:
            - bootstrap

  rescue:
    - name: Fail with clear message
      ansible.builtin.fail:
        msg: "BS-04 (Install_yamls make target) failed"

- name: "BS-04: Status"
  ansible.builtin.debug:
    msg: "BS-04: {{ 'Skipped (architecture scenario defined)' if (cifmw_architecture_scenario is defined) else (_cifmw_setup_bootstrap_install_yamls_targets_generated | default(false)) | ternary('Already configured', 'Completed') }}"
