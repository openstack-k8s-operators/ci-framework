---
# Copyright Red Hat, Inc.
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

- name: Get all PVCs in OpenStack namespace
  kubernetes.core.k8s_info:
    kubeconfig: "{{ _k8s_kubeconfig }}"
    api_key: "{{ cifmw_openshift_token | default(omit) }}"
    context: "{{ cifmw_openshift_context | default(omit) }}"
    namespace: "{{ _openstack_namespace }}"
    kind: PersistentVolumeClaim
  register: _pvc_list
  failed_when: false

- name: Delete PVCs in OpenStack namespace
  kubernetes.core.k8s:
    kubeconfig: "{{ _k8s_kubeconfig }}"
    api_key: "{{ cifmw_openshift_token | default(omit) }}"
    context: "{{ cifmw_openshift_context | default(omit) }}"
    namespace: "{{ _openstack_namespace }}"
    kind: PersistentVolumeClaim
    name: "{{ item.metadata.name }}"
    state: absent
    wait: true
    wait_timeout: 300
  loop: "{{ _pvc_list.resources | default([]) }}"
  loop_control:
    label: "{{ item.metadata.name }}"
  failed_when: false
  when:
    - _pvc_list is succeeded
    - _pvc_list.resources | default([]) | length > 0

- name: Get all secrets in OpenStack namespace
  kubernetes.core.k8s_info:
    kubeconfig: "{{ _k8s_kubeconfig }}"
    api_key: "{{ cifmw_openshift_token | default(omit) }}"
    context: "{{ cifmw_openshift_context | default(omit) }}"
    namespace: "{{ _openstack_namespace }}"
    kind: Secret
  register: _secret_list
  failed_when: false

- name: Remove finalizers from secrets and delete them
  when:
    - _secret_list is succeeded
    - _secret_list.resources | default([]) | length > 0
  block:
    - name: Remove finalizers from secret
      kubernetes.core.k8s:
        kubeconfig: "{{ _k8s_kubeconfig }}"
        api_key: "{{ cifmw_openshift_token | default(omit) }}"
        context: "{{ cifmw_openshift_context | default(omit) }}"
        namespace: "{{ _openstack_namespace }}"
        kind: Secret
        name: "{{ item.metadata.name }}"
        state: patched
        definition:
          metadata:
            finalizers: []
      loop: "{{ _secret_list.resources | default([]) }}"
      loop_control:
        label: "{{ item.metadata.name }}"
      failed_when: false
      when: _secret_list.resources | default([]) | length > 0

    - name: Delete secrets
      kubernetes.core.k8s:
        kubeconfig: "{{ _k8s_kubeconfig }}"
        api_key: "{{ cifmw_openshift_token | default(omit) }}"
        context: "{{ cifmw_openshift_context | default(omit) }}"
        namespace: "{{ _openstack_namespace }}"
        kind: Secret
        name: "{{ item.metadata.name }}"
        state: absent
        wait: true
        wait_timeout: 60
      loop: "{{ _secret_list.resources | default([]) }}"
      loop_control:
        label: "{{ item.metadata.name }}"
      failed_when: false
      when: _secret_list.resources | default([]) | length > 0

- name: Get all PersistentVolumes in Released state
  kubernetes.core.k8s_info:
    kubeconfig: "{{ _k8s_kubeconfig }}"
    api_key: "{{ cifmw_openshift_token | default(omit) }}"
    context: "{{ cifmw_openshift_context | default(omit) }}"
    kind: PersistentVolume
  register: _pv_list
  failed_when: false

- name: Release PersistentVolumes by removing claimRef
  kubernetes.core.k8s:
    kubeconfig: "{{ _k8s_kubeconfig }}"
    api_key: "{{ cifmw_openshift_token | default(omit) }}"
    context: "{{ cifmw_openshift_context | default(omit) }}"
    kind: PersistentVolume
    name: "{{ item.metadata.name }}"
    state: patched
    definition:
      spec:
        claimRef: null
  loop: "{{ _pv_list.resources | default([]) | selectattr('status.phase', 'equalto', 'Released') | list }}"
  loop_control:
    label: "{{ item.metadata.name }}"
  failed_when: false
  when:
    - _pv_list is succeeded
    - _pv_list.resources | default([]) | selectattr('status.phase', 'equalto', 'Released') | list | length > 0

- name: Delete ConfigMaps in OpenStack namespace
  kubernetes.core.k8s:
    kubeconfig: "{{ _k8s_kubeconfig }}"
    api_key: "{{ cifmw_openshift_token | default(omit) }}"
    context: "{{ cifmw_openshift_context | default(omit) }}"
    namespace: "{{ _openstack_namespace }}"
    kind: ConfigMap
    state: absent
    wait: true
    wait_timeout: 60
  failed_when: false

- name: Delete Certificates and Issuers (cert-manager)
  block:
    - name: Delete cert-manager resources by kind
      kubernetes.core.k8s:
        kubeconfig: "{{ _k8s_kubeconfig }}"
        api_key: "{{ cifmw_openshift_token | default(omit) }}"
        context: "{{ cifmw_openshift_context | default(omit) }}"
        namespace: "{{ _openstack_namespace }}"
        api_version: cert-manager.io/v1
        kind: "{{ item.kind }}"
        name: "{{ item.name | default(omit) }}"
        state: absent
        wait: true
        wait_timeout: 60
      failed_when: false
      loop:
        - kind: Issuer
        - kind: Certificate
        - kind: Issuer
          name: rootca-internal
      loop_control:
        label: "{{ item.kind }}{{ ' (' + item.name + ')' if item.name is defined else '' }}"

    - name: Delete rootca-internal secret
      kubernetes.core.k8s:
        kubeconfig: "{{ _k8s_kubeconfig }}"
        api_key: "{{ cifmw_openshift_token | default(omit) }}"
        context: "{{ cifmw_openshift_context | default(omit) }}"
        namespace: "{{ _openstack_namespace }}"
        kind: Secret
        name: rootca-internal
        state: absent
        wait: true
        wait_timeout: 60
      failed_when: false
