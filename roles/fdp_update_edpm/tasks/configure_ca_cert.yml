---
# Copyright Red Hat, Inc.
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

# This file configures OpenShift registry CA certificate on EDPM nodes
# Uses SSH to install the certificate - will be applied when deployment runs

- name: Get OpenShift ingress CA certificate
  ansible.builtin.command: >-
    oc get secret -n openshift-ingress-operator router-ca
    -o jsonpath='{.data.tls\.crt}'
  register: _cifmw_fdp_update_edpm_ca_cert_b64
  changed_when: false

- name: Decode CA certificate
  ansible.builtin.set_fact:
    _cifmw_fdp_update_edpm_ca_cert: "{{ _cifmw_fdp_update_edpm_ca_cert_b64.stdout | b64decode }}"

- name: Get EDPM node ansible hosts from nodeset
  ansible.builtin.shell: |
    oc get openstackdataplanenodeset {{ _cifmw_fdp_update_edpm_current_nodeset_name }} \
      -n {{ cifmw_fdp_update_edpm_namespace }} \
      -o json | jq -r '.spec.nodes | to_entries[] | .value.ansible.ansibleHost // .value.hostName'
  register: _cifmw_fdp_update_edpm_node_hosts
  changed_when: false

- name: Get ansible user from nodeset
  ansible.builtin.command: >-
    oc get openstackdataplanenodeset {{ _cifmw_fdp_update_edpm_current_nodeset_name }}
    -n {{ cifmw_fdp_update_edpm_namespace }}
    -o jsonpath='{.spec.nodeTemplate.ansible.ansibleUser}'
  register: _cifmw_fdp_update_edpm_ansible_user
  changed_when: false

- name: Install OpenShift registry CA certificate on EDPM nodes
  ansible.builtin.shell: |
    ssh -i ~/.ssh/id_cifw -o StrictHostKeyChecking=no {{ _cifmw_fdp_update_edpm_ansible_user.stdout }}@{{ item }} "
      echo '{{ _cifmw_fdp_update_edpm_ca_cert }}' | sudo tee /etc/pki/ca-trust/source/anchors/openshift-registry-ca.crt > /dev/null
      sudo update-ca-trust extract
    "
  loop: "{{ _cifmw_fdp_update_edpm_node_hosts.stdout_lines }}"
  when: not cifmw_fdp_update_edpm_dry_run
  changed_when: true
