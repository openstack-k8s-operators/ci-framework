---
# Copyright Red Hat, Inc.
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

# ============================================
# Validate and Initialize
# ============================================

- name: Early role stop if disabled
  when: not cifmw_fdp_update_edpm_enabled | default(true) | bool
  ansible.builtin.meta: end_play

- name: Validate required variables
  ansible.builtin.assert:
    that:
      - cifmw_fdp_update_edpm_namespace is defined
      - cifmw_fdp_update_edpm_namespace | length > 0
    fail_msg: "cifmw_fdp_update_edpm_namespace must be defined"

- name: Validate package update configuration
  ansible.builtin.assert:
    that:
      - cifmw_fdp_update_edpm_repo_baseurl is defined
      - cifmw_fdp_update_edpm_repo_baseurl | length > 0
      - cifmw_fdp_update_edpm_packages is defined
      - cifmw_fdp_update_edpm_packages | length > 0
    fail_msg: "Package updates require: cifmw_fdp_update_edpm_repo_baseurl and cifmw_fdp_update_edpm_packages"
  when: cifmw_fdp_update_edpm_packages_enabled | bool

- name: Verify oc command is available
  ansible.builtin.command: which oc
  changed_when: false

- name: Initialize updated nodesets tracking list
  ansible.builtin.set_fact:
    _cifmw_fdp_update_edpm_updated_nodesets: []

# ============================================
# Fetch NodeSets
# ============================================

- name: Fetch EDPM NodeSets
  block:
    - name: Get OpenStackDataPlaneNodeSets
      ansible.builtin.shell: |
        oc get openstackdataplanenodeset {{ cifmw_fdp_update_edpm_nodeset_name if cifmw_fdp_update_edpm_nodeset_name != 'all' else '' }} \
          -n {{ cifmw_fdp_update_edpm_namespace }} -o json
      register: _cifmw_fdp_update_edpm_nodesets_raw
      changed_when: false

    - name: Parse NodeSets
      ansible.builtin.set_fact:
        _cifmw_fdp_update_edpm_nodesets: "{{ (_cifmw_fdp_update_edpm_nodesets_raw.stdout | from_json)['items'] if cifmw_fdp_update_edpm_nodeset_name == 'all' else [_cifmw_fdp_update_edpm_nodesets_raw.stdout | from_json] }}"

    - name: Fail if no NodeSets found
      ansible.builtin.fail:
        msg: "No OpenStackDataPlaneNodeSets found in namespace {{ cifmw_fdp_update_edpm_namespace }}"
      when: _cifmw_fdp_update_edpm_nodesets | length == 0

# ============================================
# Update Container Images (Optional)
# ============================================

- name: Update container images
  when: cifmw_fdp_update_edpm_containers_enabled | bool
  ansible.builtin.include_tasks: update_container_images.yml

# ============================================
# Process Each NodeSet
# ============================================

- name: Process each NodeSet
  ansible.builtin.include_tasks: process_nodeset.yml
  loop: "{{ _cifmw_fdp_update_edpm_nodesets }}"
  loop_control:
    loop_var: nodeset
    label: "{{ nodeset.metadata.name }}"

# ============================================
# Deploy Updates to EDPM Nodes (Optional)
# ============================================

- name: Deploy updates to EDPM nodes
  when:
    - cifmw_fdp_update_edpm_auto_deploy | bool
    - not cifmw_fdp_update_edpm_dry_run | bool
    - _cifmw_fdp_update_edpm_updated_nodesets | default([]) | length > 0
  ansible.builtin.include_tasks: create_deployment.yml

# ============================================
# Summary
# ============================================

- name: Display update summary
  ansible.builtin.debug:
    msg:
      - "=============================================="
      - "EDPM Update Summary"
      - "=============================================="
      - "Updated {{ _cifmw_fdp_update_edpm_updated_nodesets | length }} NodeSet(s): {{ _cifmw_fdp_update_edpm_updated_nodesets }}"
      - "Container images updated: {{ cifmw_fdp_update_edpm_containers_enabled }}"
      - "Host packages updated: {{ cifmw_fdp_update_edpm_packages_enabled }}"
      - "=============================================="
  when: not cifmw_fdp_update_edpm_dry_run
