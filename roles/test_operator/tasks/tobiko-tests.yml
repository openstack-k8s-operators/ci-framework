---
# Copyright Red Hat, Inc.
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.
#
- name: Create tobiko.conf
  vars:
    tobikoconf_combined: >-
      {{
          cifmw_test_operator_tobiko_default_conf |
          combine(stage_vars_dict.cifmw_test_operator_tobiko_override_conf, recursive=True)
      }}
  ansible.builtin.include_tasks: create-tobiko-conf.yml
  loop: "{{ tobikoconf_combined | dict2items }}"
  loop_control:
    loop_var: tobikoconf_section

- name: Slurp tobiko.conf
  ansible.builtin.slurp:
    path: "{{ cifmw_test_operator_artifacts_basedir }}/tobiko.conf"
  register: tobikoconf_content

- name: Add config section to tobiko CR
  vars:
    tobikoconf_content_decoded: "{{ tobikoconf_content.content | b64decode }}"
  ansible.builtin.set_fact:
    test_operator_cr: >-
      {{
          test_operator_cr |
          combine({'spec': {'config': tobikoconf_content_decoded}}, recursive=true)
      }}

- name: Add ssh keys used for the VMs that tobiko creates to tobiko CR
  block:
    - name: Check if the ssh keys already exist
      ansible.builtin.stat:
        path: "{{ cifmw_test_operator_artifacts_basedir }}/id_{{ stage_vars_dict.cifmw_test_operator_tobiko_ssh_keytype }}"
      register: check_ssh_key

    - name: Create the ssh keys
      community.crypto.openssh_keypair:
        path: "{{ cifmw_test_operator_artifacts_basedir }}/id_{{ stage_vars_dict.cifmw_test_operator_tobiko_ssh_keytype  }}"
        type: "{{ stage_vars_dict.cifmw_test_operator_tobiko_ssh_keytype }}"
        size: "{{ stage_vars_dict.cifmw_test_operator_tobiko_ssh_keysize }}"
      when: not check_ssh_key.stat.exists

    - name: Slurp key files
      vars:
        keyfilename: "id_{{ stage_vars_dict.cifmw_test_operator_tobiko_ssh_keytype }}{{ '.pub' if item == 'public' else '' }}"
      ansible.builtin.slurp:
        path: "{{ cifmw_test_operator_artifacts_basedir }}/{{ keyfilename }}"
      register: key_file_content
      loop:
        - private
        - public

    - name: Add private and public keys to tobiko CR
      vars:
        keyname: "{{ item }}Key"
      ansible.builtin.set_fact:
        test_operator_cr: >-
          {{
              test_operator_cr |
              combine({'spec': {keyname: key_file_content.results[idx].content | b64decode}}, recursive=true)
          }}
      loop:
        - private
        - public
      loop_control:
        index_var: idx

- name: Add preventCreate if it is defined
  ansible.builtin.set_fact:
    test_operator_cr: >-
      {{
          test_operator_cr |
          combine({'spec': {'preventCreate': stage_vars_dict.cifmw_test_operator_tobiko_prevent_create | bool}},
                  recursive=true)
      }}
  when: stage_vars_dict.cifmw_test_operator_tobiko_prevent_create is not none

- name: Add numProcesses if it is defined
  ansible.builtin.set_fact:
    test_operator_cr: >-
      {{
          test_operator_cr |
          combine({'spec': {'numProcesses': stage_vars_dict.cifmw_test_operator_tobiko_num_processes | int}},
                  recursive=true)
      }}
  when: stage_vars_dict.cifmw_test_operator_tobiko_num_processes is not none

- name: Slurp kubeconfig file
  ansible.builtin.slurp:
    path: "{{ cifmw_openshift_kubeconfig }}"
  register: kubeconfig_file_content

- name: Ensure a secret for the kubeconfig file exists
  kubernetes.core.k8s:
    kubeconfig: "{{ cifmw_openshift_kubeconfig }}"
    api_key: "{{ cifmw_openshift_token | default(omit) }}"
    context: "{{ cifmw_openshift_context | default(omit) }}"
    state: present
    wait: true
    definition:
      apiVersion: v1
      kind: Secret
      type: Opaque
      metadata:
        name: "{{ stage_vars_dict.cifmw_test_operator_tobiko_kubeconfig_secret }}"
        namespace: "{{ stage_vars_dict.cifmw_test_operator_namespace }}"
      data:
        # b64decode not needed because the text has to be encoded
        config: "{{ kubeconfig_file_content.content }}"
  when: not cifmw_test_operator_dry_run | bool
