- name: Set fact for client_name
  ansible.builtin.set_fact:
    client_name: "{{ cifmw_hsm_client_ip }}"

- name: Generate a new client cert for NTL
  ansible.builtin.command: /usr/safenet/lunaclient/bin/vtl createCert -n "{{ cifmw_hsm_client_ip }}"
  become: true

- name: Get the hsm server cert from the hsm_server
  ansible.builtin.shell: >
    sshpass -p '{{ cifmw_hsm_admin_password }}'
    scp -O -o StrictHostKeyChecking=false -c aes256-cbc
    {{ cifmw_hsm_admin_user }}@{{ cifmw_hsm_server_ip }}:server.pem
    /usr/safenet/lunaclient/bin/{{ cifmw_hsm_server_ip }}.pem
  args:
    creates: /usr/safenet/lunaclient/bin/{{ cifmw_hsm_server_ip }}.pem
  become: true

- name: Delete existing client if present
  ansible.builtin.shell: >
    sshpass -p '{{ cifmw_hsm_admin_password }}'
    ssh -c aes256-cbc {{ cifmw_hsm_admin_user }}@{{ cifmw_hsm_server_ip }}
    -C "client delete -f -c {{ client_name }}"
  register: client_delete
  failed_when:
    - client_delete.rc != 0
    - "'There is no registered client with the name you specified' not in client_delete.stdout"

- name: Copy the NTL client cert to the HSM
  ansible.builtin.shell: >
    sshpass -p '{{ cifmw_hsm_admin_password }}' scp -O -c aes256-cbc
    /usr/safenet/lunaclient/cert/client/{{ cifmw_hsm_client_ip }}.pem
    {{ cifmw_hsm_admin_user }}@{{ cifmw_hsm_server_ip }}:{{ cifmw_hsm_client_ip }}.pem

- name: Register the client
  ansible.builtin.shell: >
    sshpass -p '{{ cifmw_hsm_admin_password }}'
    ssh -c aes256-cbc {{ cifmw_hsm_admin_user }}@{{ cifmw_hsm_server_ip }}
    -C "client register -c {{ client_name }} -ip {{ cifmw_hsm_client_ip }}"
  register: client_register
  failed_when:
    - client_register.rc != 0
    - "'client with the same IP address has already been registered' not in client_register.stdout"

- name: Assign client to an HSM partition
  ansible.builtin.shell: >
    sshpass -p '{{ cifmw_hsm_admin_password }}'
    ssh -c aes256-cbc {{ cifmw_hsm_admin_user }}@{{ cifmw_hsm_server_ip }}
    -C "client assignPartition -c {{ client_name }} -p {{ cifmw_hsm_luna_partition }}"
  register: assign_partition
  failed_when:
    - assign_partition.rc != 0
    - "'client already has access' not in assign_partition.stdout"
  become: true
