#!/bin/bash
# OIDC Authorization Code flow configuration
# This script configures authentication using OAuth 2.0 Authorization Code grant type
# The authorization code is passed as an argument: source oidc-authcode.sh <AUTH_CODE>

AUTH_CODE="$1"

if [ -z "$AUTH_CODE" ]; then
    echo "Usage: source oidc-authcode.sh <AUTH_CODE>"
    echo "Error: Authorization code is required"
    return 1
fi

unset OS_CLOUD
export OS_CACERT=/home/cloud-admin/full-ca-list.crt
export OS_AUTH_URL="{{ cifmw_federation_keystone_url }}/v3"
export OS_IDENTITY_API_VERSION=3
export OS_AUTH_TYPE=v3oidcauthcode
export OS_IDENTITY_PROVIDER="{{ cifmw_federation_IdpName }}"
export OS_CLIENT_ID="{{ cifmw_federation_keystone_OIDC_ClientID }}"
export OS_CLIENT_SECRET="{{ cifmw_federation_keystone_OIDC_ClientSecret }}"
export OS_OPENID_SCOPE="openid profile email"
export OS_PROTOCOL=openid
export OS_ACCESS_TOKEN_TYPE=access_token
export OS_DISCOVERY_ENDPOINT="{{ cifmw_federation_keycloak_url }}/auth/realms/{{ cifmw_federation_keycloak_realm }}/.well-known/openid-configuration"
export OS_REDIRECT_URI="{{ cifmw_federation_keystone_url }}/v3/redirect_uri"
export OS_CODE="$AUTH_CODE"
