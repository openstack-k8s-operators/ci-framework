---
- name: Render enable-federation-openidc.yaml to undercloud
  delegate_to: "{{ cifmw_federation_undercloud_host | default('osp-undercloud-0') }}"
  ansible.builtin.template:
    src: "enable-federation-openidc.yaml.j2"
    dest: "{{ ansible_user_dir }}/enable-federation-openidc.yaml"
    mode: "0644"

- name: Create federation mapping file on undercloud
  delegate_to: "{{ cifmw_federation_undercloud_host | default('osp-undercloud-0') }}"
  ansible.builtin.copy:
    dest: "{{ ansible_user_dir }}/mapping.json"
    mode: "0644"
    content: |
      [
        {
          "local": [
            {
              "user": {"name": "{0}"},
              "group": {
                "domain": {"name": "{{ cifmw_federation_domain }}"},
                "name": "{{ cifmw_federation_group_name }}"
              }
            }
          ],
          "remote": [
            {"type": "OIDC-preferred_username"}
          ]
        }
      ]

- name: Ensure federation domain exists (OSP 17.1)
  delegate_to: "{{ cifmw_federation_undercloud_host | default('osp-undercloud-0') }}"
  environment:
    OS_CLOUD: "{{ cifmw_adoption_osp_deploy_scenario.stacks[0].stackname | default('overcloud') }}"
  ansible.builtin.shell: |
    set -e
    openstack domain show {{ cifmw_federation_domain }} >/dev/null 2>&1 || \
    openstack domain create {{ cifmw_federation_domain }}

- name: Ensure identity provider exists (OSP 17.1)
  delegate_to: "{{ cifmw_federation_undercloud_host | default('osp-undercloud-0') }}"
  environment:
    OS_CLOUD: "{{ cifmw_adoption_osp_deploy_scenario.stacks[0].stackname | default('overcloud') }}"
  ansible.builtin.shell: |
    set -e
    IDP_URL="{{ cifmw_federation_keycloak_url }}/auth/realms/{{ cifmw_federation_keycloak_realm }}"
    openstack identity provider show {{ cifmw_federation_IdpName }} >/dev/null 2>&1 || \
    openstack identity provider create --remote-id ${IDP_URL} --domain {{ cifmw_federation_domain }} {{ cifmw_federation_IdpName }}

- name: Ensure mapping exists (OSP 17.1)
  delegate_to: "{{ cifmw_federation_undercloud_host | default('osp-undercloud-0') }}"
  environment:
    OS_CLOUD: "{{ cifmw_adoption_osp_deploy_scenario.stacks[0].stackname | default('overcloud') }}"
  ansible.builtin.shell: |
    set -e
    openstack mapping show {{ cifmw_federation_mapping_name }} >/dev/null 2>&1 || \
    openstack mapping create --rules {{ ansible_user_dir }}/mapping.json {{ cifmw_federation_mapping_name }}

- name: Ensure federated group exists (OSP 17.1)
  delegate_to: "{{ cifmw_federation_undercloud_host | default('osp-undercloud-0') }}"
  environment:
    OS_CLOUD: "{{ cifmw_adoption_osp_deploy_scenario.stacks[0].stackname | default('overcloud') }}"
  ansible.builtin.shell: |
    set -e
    openstack group show {{ cifmw_federation_group_name }} --domain {{ cifmw_federation_domain }} >/dev/null 2>&1 || \
    openstack group create --domain {{ cifmw_federation_domain }} {{ cifmw_federation_group_name }}

- name: Ensure project exists (OSP 17.1)
  delegate_to: "{{ cifmw_federation_undercloud_host | default('osp-undercloud-0') }}"
  environment:
    OS_CLOUD: "{{ cifmw_adoption_osp_deploy_scenario.stacks[0].stackname | default('overcloud') }}"
  ansible.builtin.shell: |
    set -e
    openstack project show {{ cifmw_federation_project_name }} --domain {{ cifmw_federation_domain }} >/dev/null 2>&1 || \
    openstack project create --domain {{ cifmw_federation_domain }} {{ cifmw_federation_project_name }}

- name: Ensure role binding exists (OSP 17.1)
  delegate_to: "{{ cifmw_federation_undercloud_host | default('osp-undercloud-0') }}"
  environment:
    OS_CLOUD: "{{ cifmw_adoption_osp_deploy_scenario.stacks[0].stackname | default('overcloud') }}"
  ansible.builtin.shell: |
    set -e
    openstack role add --group {{ cifmw_federation_group_name }} --group-domain {{ cifmw_federation_domain }} --project {{ cifmw_federation_project_name }} --project-domain {{ cifmw_federation_domain }} member || true

- name: Ensure federation protocol exists (OSP 17.1)
  delegate_to: "{{ cifmw_federation_undercloud_host | default('osp-undercloud-0') }}"
  environment:
    OS_CLOUD: "{{ cifmw_adoption_osp_deploy_scenario.stacks[0].stackname | default('overcloud') }}"
  ansible.builtin.shell: |
    set -e
    openstack federation protocol show openid --identity-provider {{ cifmw_federation_IdpName }} >/dev/null 2>&1 || \
    openstack federation protocol create openid --mapping {{ cifmw_federation_mapping_name }} --identity-provider {{ cifmw_federation_IdpName }}
