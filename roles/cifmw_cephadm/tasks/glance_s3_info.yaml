---
 # Copyright 2025 Red Hat, Inc.
 # All Rights Reserved.
 #
 # Licensed under the Apache License, Version 2.0 (the "License"); you may
 # not use this file except in compliance with the License. You may obtain
 # a copy of the License at
 #
 #     http://www.apache.org/licenses/LICENSE-2.0
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 # WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 # License for the specific language governing permissions and limitations
 # under the License.

- name: Create glance S3 RGW user and fetch object-store endpoint
  when: cifmw_cephadm_rgw_s3_glance | default(false) | bool
  block:
    - name: Refresh ceph_cli
      ansible.builtin.include_tasks: ceph_cli.yml
      vars:
        ceph_command: "radosgw-admin"

    - name: Wait for RGW daemons to be running
      ansible.builtin.command:
        cmd: "{{ cifmw_cephadm_ceph_cli }} orch ps --daemon-type rgw --format json"
      register: rgw_daemon_status
      become: true
      changed_when: false
      failed_when: false
      until: >
        rgw_daemon_status.rc == 0 and
        (rgw_daemon_status.stdout | default('[]') | from_json) |
        selectattr('status_desc', 'equalto', 'running') |
        list | length > 0
      retries: 30
      delay: 10

    - name: Check if Ceph S3 glance user exists
      ansible.builtin.command:
        cmd: >-
          {{ cifmw_cephadm_ceph_cli }} user info --uid glance
      no_log: "{{ cifmw_nolog | default(true) | bool }}"
      become: true
      ignore_errors: true
      changed_when: false
      register: cifmw_ceph_s3_glance_user_check
      when: cifmw_cephadm_ceph_cli is defined

    - name: Create Ceph S3 glance user
      ansible.builtin.command:
        cmd: >-
          {{ cifmw_cephadm_ceph_cli }} user create
          --uid="glance"
          --display-name="Glance S3 User"
      no_log: "{{ cifmw_nolog | default(true) | bool }}"
      become: true
      when:
        - cifmw_ceph_s3_glance_user_check is not skipped
        - cifmw_ceph_s3_glance_user_check.rc != 0
      register: glance_rgw_user_create
      retries: 3
      delay: 5
      until: glance_rgw_user_create.rc == 0

    - name: Get RGW glance user info
      ansible.builtin.command:
        cmd: >-
          {{ cifmw_cephadm_ceph_cli }} user info --uid="glance"
      become: true
      no_log: "{{ cifmw_nolog | default(true) | bool }}"
      changed_when: false
      register: ceph_rgw_glance_user_info

    - name: Show RGW daemon status on failure
      when: ceph_rgw_glance_user_info.rc != 0
      block:
        - name: Get RGW daemon status for debugging
          ansible.builtin.command:
            cmd: "{{ cifmw_cephadm_ceph_cli }} orch ps --daemon-type rgw"
          become: true
          register: rgw_debug_status
          changed_when: false

        - name: Display RGW status
          ansible.builtin.debug:
            msg: "RGW daemon status: {{ rgw_debug_status.stdout }}"

        - name: Fail with context
          ansible.builtin.fail:
            msg: |
              Failed to fetch glance user info after creation.
              User creation result: {{ glance_rgw_user_create | default('not attempted') }}
              RGW daemon status shown above.

    - name: Set facts RGW glance user
      ansible.builtin.set_fact:
        cifmw_ceph_s3_glance_user: "{{ ceph_rgw_glance_user_info.stdout | from_json }}"
      when:
        - ceph_rgw_glance_user_info is defined
        - ceph_rgw_glance_user_info.rc == 0
      no_log: "{{ cifmw_nolog | default(true) | bool }}"
