---
# Copyright Red Hat, Inc.
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

- name: Render the post-ceph values.yaml
  ansible.builtin.template:
    mode: "0644"
    backup: true
    src: "templates/values.yaml.j2"
    dest: "{{ ci_dcn_site_arch_path }}/values.yaml"

- name: Find all ceph variable files
  register: _ceph_vars_files
  ansible.builtin.find:
    paths: "/tmp"
    patterns: "ceph_client_az*.yml"
    recurse: false

- name: Load all ceph vars from files
  loop: "{{ _ceph_vars_files.files | map(attribute='path') | list }}"
  register: _ceph_vars
  ansible.builtin.include_vars:
    file: "{{ item }}"

- name: Combine ceph variables into a list of dictionaries
  loop: "{{ _ceph_vars.results }}"
  ansible.builtin.set_fact:
    _ceph_vars_list: "{{ _ceph_vars_list | union([item.ansible_facts]) }}"

- name: Render the post-ceph service-values.yaml
  ansible.builtin.template:
    mode: "0644"
    backup: true
    src: "templates/service-values.yaml.j2"
    dest: "{{ ci_dcn_site_arch_path }}/service-values.yaml"

- name: Kustomize post-ceph NodeSet
  ansible.builtin.set_fact:
    post_ceph_nodeset_cr: >-
      {{ lookup('kubernetes.core.kustomize',
      dir=ci_dcn_site_arch_path) }}

- name: Save the post-ceph NodeSet CR
  ansible.builtin.copy:
    mode: "0644"
    dest: "{{ ci_dcn_site_arch_path }}/dataplane-nodeset-post-ceph_{{ _az }}.yaml"
    content: "{{ post_ceph_nodeset_cr }}"
    backup: true

- name: Render the post-ceph DataPlaneDeployment values.yaml
  ansible.builtin.template:
    mode: "0644"
    backup: true
    src: "templates/deployment/values.yaml.j2"
    dest: "{{ ci_dcn_site_arch_path }}/deployment/values.yaml"

- name: Kustomize post-ceph DataPlaneDeployment
  ansible.builtin.set_fact:
    post_ceph_deployment_cr: >-
      {{ lookup('kubernetes.core.kustomize',
      dir=ci_dcn_site_arch_path + '/deployment') }}

- name: Save the post-ceph DataPlaneDeployment CR
  ansible.builtin.copy:
    mode: "0644"
    dest: "{{ ci_dcn_site_arch_path }}/dataplane-deployment-post-ceph_{{ _az }}.yaml"
    content: "{{ post_ceph_deployment_cr }}"
    backup: true

- name: Apply post-ceph NodeSet CR
  register: result
  retries: 5
  delay: 10
  until: result is not failed
  kubernetes.core.k8s:
    api_key: "{{ _auth_results.openshift_auth.api_key }}"
    state: present
    apply: true
    src: "{{ ci_dcn_site_arch_path }}/dataplane-nodeset-post-ceph_{{ _az }}.yaml"

- name: Apply post-ceph DataPlaneDeployment CR
  register: result
  retries: 5
  delay: 10
  until: result is not failed
  kubernetes.core.k8s:
    api_key: "{{ _auth_results.openshift_auth.api_key }}"
    state: present
    apply: true
    src: "{{ ci_dcn_site_arch_path }}/dataplane-deployment-post-ceph_{{ _az }}.yaml"
    wait: true
    wait_condition:
      type: Ready
      status: "True"
    wait_timeout: 3200
