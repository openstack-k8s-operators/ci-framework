---
# Copyright Red Hat, Inc.
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

# When mirror_images is enabled in dev-scripts, the pull-secret is replaced
# with only the local mirror registry credentials during installation.
# This task restores the original pull-secret post-installation to allow
# pulling images from external registries for operators and other workloads.

- name: Get original pull-secret content
  no_log: true
  ansible.builtin.slurp:
    src: "{{ cifmw_devscripts_repo_dir }}/pull_secret.json"
  register: _original_pull_secret

- name: Get current cluster pull-secret
  no_log: true
  kubernetes.core.k8s_info:
    kubeconfig: "{{ cifmw_openshift_kubeconfig }}"
    api_key: "{{ cifmw_openshift_token | default(omit) }}"
    context: "{{ cifmw_openshift_context | default(omit) }}"
    kind: Secret
    name: pull-secret
    namespace: openshift-config
  register: _cluster_pull_secret_raw

- name: Update cluster pull-secret
  no_log: true
  vars:
    _original_auths: "{{ (_original_pull_secret.content | b64decode | from_json).auths }}"
    _cluster_auths: "{{ (_cluster_pull_secret_raw.resources[0].data['.dockerconfigjson'] | b64decode | from_json).auths }}"
    _merged_pull_secret:
      auths: "{{ _cluster_auths | combine(_original_auths, recursive=true) }}"
  kubernetes.core.k8s:
    kubeconfig: "{{ cifmw_openshift_kubeconfig }}"
    api_key: "{{ cifmw_openshift_token | default(omit) }}"
    context: "{{ cifmw_openshift_context | default(omit) }}"
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: pull-secret
        namespace: openshift-config
      type: kubernetes.io/dockerconfigjson
      data:
        .dockerconfigjson: "{{ _merged_pull_secret | to_json | b64encode }}"

- name: Wait for nodes to stabilize after pull-secret update
  kubernetes.core.k8s_info:
    kubeconfig: "{{ cifmw_openshift_kubeconfig }}"
    api_key: "{{ cifmw_openshift_token | default(omit) }}"
    context: "{{ cifmw_openshift_context | default(omit) }}"
    kind: Node
  register: _nodes
  retries: 20
  delay: 30
  until: >-
    _nodes.resources | length > 0 and
    _nodes.resources | selectattr('status.conditions', 'defined') |
    map(attribute='status.conditions') | flatten |
    selectattr('type', 'equalto', 'Ready') |
    selectattr('status', 'equalto', 'True') |
    list | length == (_nodes.resources | length)

- name: Re-enable OperatorHub default sources
  kubernetes.core.k8s_json_patch:
    kubeconfig: "{{ cifmw_openshift_kubeconfig }}"
    api_version: config.openshift.io/v1
    kind: OperatorHub
    name: cluster
    patch:
      - op: replace
        path: /spec/disableAllDefaultSources
        value: false

- name: Display pull-secret restoration status
  ansible.builtin.debug:
    msg: >-
      Pull-secret has been restored with original credentials while keeping local mirror registry access.
      OperatorHub default sources have been re-enabled to allow operator installation.
