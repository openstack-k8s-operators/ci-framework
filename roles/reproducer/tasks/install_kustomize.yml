---
# Copyright Red Hat, Inc.
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.


- name: Ensure the directories exist
  ansible.builtin.file:
    path: "{{ item.dir_name }}"
    mode: "{{ item.mode }}"
    state: "directory"
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_id }}"
  loop:
    - dir_name: >-
        {{
          (cifmw_reproducer_basedir, 'tmp') | ansible.builtin.path_join
        }}
      mode: "0755"
    - dir_name: >- 
        {{
          (ansible_user_dir, '.local') | ansible.builtin.path_join
        }}
      mode: "0700"
    - dir_name: >-
        {{
          (ansible_user_dir, '.local', 'bin') | ansible.builtin.path_join
        }}
      mode: "0755"
  loop_control:
    label: "{{ item.dir_name }}"

- name: Download the kustomize install script
  ansible.builtin.get_url:
    url: "{{ cifmw_reproducer_kustomize_install_script }}"
    dest: >-
      {{
        (
          cifmw_reproducer_basedir,
          'tmp',
          'install-kustomize.sh'
        ) | ansible.builtin.path_join
      }}
    mode: '0755'
    validate_certs: false

- name: Execute the kustomize install script
  ansible.builtin.command:
    chdir: >-
      {{
        (ansible_user_dir, '.local', 'bin') | ansible.builtin.path_join
      }}
    cmd: >-
      {{
        (cifmw_reproducer_basedir, 'tmp', 'install-kustomize.sh')
        | ansible.builtin.path_join
      }}
    creates: >-
      {{
        (ansible_user_dir, '.local', 'bin', 'kustomize')
        | ansible.builtin.path_join
      }}
