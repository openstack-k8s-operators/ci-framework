---
- name: Make OCP cluster nodes DHCP leases reservations
  when:
    - cifmw_hosts_ports is defined
  vars:
    _ocp_hosts_ports: >-
      {{
        cifmw_hosts_ports | default({}) | dict2items |
        selectattr('key', 'match', '^ocp.*$') |
        items2dict
      }}
    cifmw_network_dnsmasq_config_static_leases: >-
      {% set _leases = [] -%}
      {% for host, net_data in (_ocp_hosts_ports | default({})).items() -%}
      {%   for port_data in (net_data | default({})).values() -%}
      {%       set _ = _leases.append({'host': host} | combine(port_data, recursive=true)) -%}
      {%   endfor -%}
      {% endfor -%}
      {{ _leases }}
  ansible.builtin.include_role:
    name: ci_network
    tasks_from: add-static-leases.yml

- name: Get needed artifacts generated by dev-scripts
  vars:
    _auth_path: >-
      {{
        (
          cifmw_devscripts_repo_dir,
          'ocp',
          cifmw_devscripts_config.cluster_name,
          'auth'
        ) | ansible.builtin.path_join
      }}
    _k8s_config: "{{ (_auth_path, 'kubeconfig') | ansible.builtin.path_join }}"
  block:
    - name: Slurp devscripts private key
      register: _devscript_privkey
      ansible.builtin.slurp:
        path: >-
          {{
            (cifmw_reproducer_basedir,
            'artifacts',
            'cifmw_ocp_access_key') |
            path_join
          }}

    - name: Slurp content of the devscripts kubeconfig
      register: _devscripts_kubeconfig
      ansible.builtin.slurp:
        path: "{{ _k8s_config }}"

    - name: Slurp content of the devscripts kubeadmin-password
      register: _devscripts_kubeadm
      ansible.builtin.slurp:
        path: >-
          {{
            (_auth_path, 'kubeadmin-password') | ansible.builtin.path_join
          }}

    - name: Ensure we expose openshift_login related facts
      ansible.builtin.import_role:
        name: devscripts
        tasks_from: set_cluster_fact.yml

    - name: Ensure the OpenShift cluster is stable.
      vars:
        cifmw_openshift_adm_op: "stable"
        cifmw_openshift_kubeconfig: "{{ _k8s_config }}"
      ansible.builtin.include_role:
        name: openshift_adm
