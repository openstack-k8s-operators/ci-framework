---
- name: Ensure we get latest OCP config
  ansible.builtin.include_role:
    name: "devscripts"
    tasks_from: "build_config.yml"

- name: Ensure NetworkManager is configured to use dnsmasq
  become: true
  notify: Restart NetworkManager
  ansible.builtin.copy:
    dest: "{{ cifmw_reproducer_nm_dnsmasq }}"
    mode: "0644"
    content: |
      [main]
      dns=dnsmasq

- name: Flush handlers for NetworkManager restart
  ansible.builtin.meta: flush_handlers

- name: Ensure no default networks exists
  vars:
    net_name: "{{ item }}"
  ansible.builtin.include_role:
    name: libvirt_manager
    tasks_from: delete_network.yml
  loop:
    - crc
    - default

- name: Ensure basic host configurations are present
  become: true
  block:
    - name: Ensure firewalld is installed
      ansible.builtin.package:
        name:
          - firewalld

    - name: Ensure br_netfilter module is loaded
      community.general.modprobe:
        name: br_netfilter
        state: present

    - name: Ensure IP forwarding is enabled
      ansible.posix.sysctl:
        name: net.ipv4.ip_forward
        value: 1
        state: present

    - name: Ensure the required parameters are loaded
      ansible.posix.sysctl:
        name: "net.bridge.bridge-nf-call-{{ item }}"
        value: 0
        state: present
      loop:
        - arptables
        - iptables
        - ip6tables
      loop_control:
        label: "{{ item }}"

    - name: Ensure firewall service is enabled and started
      ansible.builtin.service:
        name: firewalld
        enabled: true
        state: started

- name: Create the virtual networks
  when:
    - cifmw_libvirt_manager_mac_map is undefined
  ansible.builtin.include_role:
    name: libvirt_manager
    tasks_from: generate_networking_data.yml

- name: Delegate our domains to our own instance
  become: true
  notify: Restart NetworkManager
  vars:
    _ip_4: >-
      {{ _libvirt_manager_networking.networks.ctlplane.gw_v4 | default('') }}
    _ip_6: >-
      {{ _libvirt_manager_networking.networks.ctlplane.gw_v6 | default('') }}
    _domain: "{{ cifmw_devscripts_config.base_domain }}"
  ansible.builtin.copy:
    dest: "{{ cifmw_reproducer_nm_delegation }}"
    mode: "0644"
    content: |
      # Managed by ci-framework/reproducer
      server=/{{ _domain }}/127.0.0.2
      server=/{{ _domain }}/::2

- name: Flush handlers
  ansible.builtin.meta: flush_handlers
