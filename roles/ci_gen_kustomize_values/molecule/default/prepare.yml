---
# Copyright Red Hat, Inc.
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.


- name: Prepare
  hosts: all
  vars:
    cifmw_ci_gen_kustomize_values_src_dir: >-
      {{
        (ansible_user_dir,
         'ci-framework-data',
         'artifacts', 'ci_k8s_snippets') | path_join
      }}
  roles:
    - role: test_deps
  tasks:
    - name: Create snippet directory
      ansible.builtin.file:
        path: "{{ cifmw_ci_gen_kustomize_values_src_dir }}"
        state: directory
        mode: "0755"

    - name: Push snippet-1
      ansible.builtin.copy:
        dest: "{{ cifmw_ci_gen_kustomize_values_src_dir }}/my-snippet-1.yaml"
        content: |
          data:
            node_0:
              name: crc
              ctlplane_ip: 192.168.122.10
              storage_ip: 172.18.0.10

    - name: Push snippet-2
      ansible.builtin.copy:
        dest: "{{ cifmw_ci_gen_kustomize_values_src_dir }}/my-snippet-2.yaml"
        content: |
          data:
            ctlplane:
              dnsDomain: ctlplane.example.local
              subnets:
                - allocationRanges:
                    - end: 192.168.122.120
                      start: 192.168.122.100
                    - end: 192.168.122.200
                      start: 192.168.122.150
                  cidr: 192.168.122.0/24
                  gateway: 192.168.122.1
                  name: subnet1
              prefix-length: 24
              mtu: 1500
              iface: eth0
              lb_addresses:
                - 192.168.122.80-192.168.122.90
              endpoint_annotations:
                metallb.universe.tf/address-pool: ctlplane
                metallb.universe.tf/allow-shared-ip: ctlplane
                metallb.universe.tf/loadBalancerIPs: 192.168.122.80
              net-attach-def: |
                {
                  "cniVersion": "0.3.1",
                  "name": "ctlplane",
                  "type": "macvlan",
                  "master": "eth0",
                  "ipam": {
                    "type": "whereabouts",
                    "range": "192.168.122.0/24",
                    "range_start": "192.168.122.30",
                    "range_end": "192.168.122.70"
                  }
                }
