- name: Assert we have needed host record data
  ansible.builtin.assert:
    quiet: true
    that:
      - cifmw_dnsmasq_host_record is defined
      - (cifmw_dnsmasq_host_record | type_debug) == "list"

- name: Assert each address element have needed data
  ansible.builtin.assert:
    quiet: true
    that:
      - item.state is defined
      - item.state in ['present', 'absent']
      - item.ips is defined
      - (item.ips | type_debug) == "list"
      - item.names is defined
      - (item.names | type_debug) == "list"
  loop: "{{ cifmw_dnsmasq_host_record }}"

- name: Add/Remove address
  become: true
  notify: Restart dnsmasq
  vars:
    _rec: >-
      {{
        (item.names + item.ips) | reject('match', '^$')
      }}
  ansible.builtin.lineinfile:
    create: true
    path: "{{ cifmw_dnsmasq_basedir }}/host_records.conf"
    mode: '0644'
    line: >-
      host-record={{ _rec | join(',') }}
    state: "{{ item.state }}"
    validate: "/usr/sbin/dnsmasq -C %s --test"
  loop: "{{ cifmw_dnsmasq_host_record }}"

# NOTE(dpawlik): Add short name like controller-0
# into the /etc/hosts file, to avoid errors when all the configuration
# is only stored in ssh config files.
# It has been done into /etc/hosts, due dnsmasq require to contain a domain.
- name: Add controller-0 short hostname record when 'utility' in the name into /etc/hosts
  when:
    - cifmw_dnsmasq_shortnames_etc_hosts
    - record.names | select('search', 'utility') | list | length > 0
    - record.names | select('search', 'controller-0') | list | length > 0
  become: true
  ansible.builtin.lineinfile:
    path: "/etc/hosts"
    line: "{{ ip }} {{ short_name }}"
    state: "{{ record.state }}"
  loop: "{{ cifmw_dnsmasq_host_record }}"
  loop_control:
    loop_var: record
  vars:
    short_name: "{{ record.names[0] | regex_replace('^([^.]+)\\..*$', '\\1') }}"
    ip: "{{ record.ips[0] }}"
