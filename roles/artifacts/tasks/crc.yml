---
- name: Ensure controller knows CRC ssh keys
  ignore_errors: true # noqa: ignore-errors
  register: crc_host_key
  ansible.builtin.shell:
    cmd: >-
      ssh-keyscan {{ cifmw_artifacts_crc_host }} >> ~/.ssh/known_hosts

- name: Get CRC things only if we know it
  when:
    - crc_host_key is defined
    - crc_host_key.rc is defined
    - crc_host_key.rc == 0
  block:
    - name: Create crc logs directory
      ignore_errors: true # noqa: ignore-errors
      ansible.builtin.file:
        path: "{{ cifmw_artifacts_basedir }}/logs/crc"
        state: directory
        mode: "0755"

    - name: Create crc logs directory
      become: true
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/logs/crc"
        state: directory
        mode: "0755"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      delegate_to: "{{ cifmw_artifacts_crc_host }}"

    - name: Copy logs
      become: true
      ansible.builtin.copy:
        src: /ostree/deploy/rhcos/var/log/pods
        dest: "{{ ansible_user_dir }}/logs/crc"
        remote_src: true
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0644"
      delegate_to: "{{ cifmw_artifacts_crc_host }}"

    - name: Copy logs from CRC VM
      ansible.posix.synchronize:
        src: "core@{{ cifmw_artifacts_crc_host }}:{{ ansible_user_dir }}/logs/crc/"
        dest: "{{ cifmw_artifacts_basedir }}/logs/crc/"
        mode: pull
        archive: true
        recursive: true
      delegate_to: "{{ cifmw_artifacts_crc_host }}"
      ignore_errors: true # noqa: ignore-errors
