---
# CI playbook orchestrator for OpenStack minor version updates.
# This playbook runs on the zuul host (cifmw_zuul_target_host) and orchestrates
# the update by calling the update role's update_variant_ci.yml task (no nested ansible-playbook).
# This playbook depends on content provider variables from CI jobs.
# This is Phase 2 of the baremetal update workflow and should be called
# sequentially after run.yml (Phase 1).

- name: OpenStack minor version update orchestrator
  hosts: "{{ cifmw_zuul_target_host | default('all') }}"
  gather_facts: false
  tasks:
    - name: Filter out host if needed
      when:
        - cifmw_zuul_target_host is defined
        - cifmw_zuul_target_host != 'all'
        - inventory_hostname != cifmw_zuul_target_host
      ansible.builtin.meta: end_host

    - name: Set cifmw_basedir if not defined
      ansible.builtin.set_fact:
        cifmw_basedir: "{{ cifmw_basedir | default(ansible_user_dir ~ '/ci-framework-data') }}"

    - name: Get minor update index image from content provider or use default
      ansible.builtin.set_fact:
        cifmw_minor_update_index_image: >-
          {{
            cifmw_operator_build_output.operators['openstack-operator'].image_catalog
            if (cifmw_operator_build_output is defined and
                cifmw_operator_build_output.operators is defined and
                'openstack-operator' in cifmw_operator_build_output.operators)
            else cifmw_minor_update_pre_update_index_image | default('quay.io/openstack-k8s-operators/openstack-operator-index:18.0-fr3-latest')
          }}

    - name: Write minor update index image to parameters file
      ansible.builtin.copy:
        dest: "{{ ansible_user_dir }}/ci-framework-data/artifacts/parameters/minor_update_index_image.yml"
        content: "{{ {'cifmw_minor_update_index_image': cifmw_minor_update_index_image} | to_nice_yaml }}"
        mode: "0644"
      when: cifmw_minor_update_index_image is defined

    - name: Load all parameters from parameters directory
      vars:
        provided_dir: "{{ ansible_user_dir }}/ci-framework-data/artifacts/parameters"
      ansible.builtin.include_role:
        name: cifmw_helpers
        tasks_from: var_dir.yml

    - name: Run minor update using update role
      ansible.builtin.include_role:
        name: update
        tasks_from: update_variant_ci.yml
