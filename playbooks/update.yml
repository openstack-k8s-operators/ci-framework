- name: Run pre_update hooks
  vars:
    step: pre_update
  ansible.builtin.import_playbook: ./hooks.yml

- name: Update repos and openstack services containers
  hosts: "{{ cifmw_target_host | default('localhost') }}"
  gather_facts: false
  tasks:
    - name: Run repo_setup
      ansible.builtin.include_role:
        name: repo_setup
    - name: Run update-containers
      ansible.builtin.include_role:
        name: update_containers
      when: cifmw_update_containers | bool

- name: Sync repos for controller to compute
  hosts: computes
  gather_facts: true
  tasks:
    - name: Copy repositories from controller to computes
      become: true
      ansible.builtin.copy:
        dest: "/etc/yum.repos.d/"
        src: "{{ cifmw_basedir }}/artifacts/repositories/"

- name: Run update role
  hosts: "{{ cifmw_target_host | default('localhost') }}"
  gather_facts: false
  tasks:
    - name: Run update
      tags:
        - update
      ansible.builtin.import_role:
        name: update

- name: Run post_update hooks
  vars:
    step: post_update
  ansible.builtin.import_playbook: ./hooks.yml
