---
# Copyright Red Hat, Inc.
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

# Master playbook to update OpenStack packages across all layers:
# - Control plane containers
# - EDPM compute containers
# - EDPM compute node hosts
#
# Granular control via flags:
#   cifmw_fdp_update_container_images_update_control_plane_images: true/false
#   cifmw_fdp_update_container_images_update_edpm_images: true/false
#   cifmw_fdp_update_container_images_update_edpm_host_packages: true/false
#
# Usage Examples:
#
# 1. Update everything (default):
#   ansible-playbook playbooks/fdp_update.yml \
#     -e cifmw_fdp_update_container_images_target_package=ovn24.03 \
#     -e cifmw_fdp_update_container_images_repo_baseurl=http://example.com/repo/
#
# 2. Update only control plane:
#   ansible-playbook playbooks/fdp_update.yml \
#     -e cifmw_fdp_update_container_images_target_package=ovn24.03 \
#     -e cifmw_fdp_update_container_images_repo_baseurl=http://example.com/repo/ \
#     -e cifmw_fdp_update_container_images_update_edpm_images=false \
#     -e cifmw_fdp_update_container_images_update_edpm_host_packages=false
#
# 3. Update only EDPM host packages:
#   ansible-playbook playbooks/fdp_update.yml \
#     -e cifmw_fdp_update_container_images_target_package=openvswitch3.3 \
#     -e cifmw_fdp_update_container_images_repo_baseurl=http://example.com/ovs-repo/ \
#     -e cifmw_fdp_update_container_images_update_control_plane_images=false \
#     -e cifmw_fdp_update_container_images_update_edpm_images=false

- name: Update OpenStack packages across all layers
  hosts: "{{ cifmw_target_host | default('localhost') }}"
  gather_facts: true

  pre_tasks:
    - name: Early playbook stop if disabled
      when:
        - not cifmw_fdp_update_enabled | default(false) | bool
      ansible.builtin.meta: end_play

    - name: Validate required variables are set
      ansible.builtin.assert:
        that:
          - cifmw_fdp_update_container_images_target_package is defined
          - cifmw_fdp_update_container_images_target_package | length > 0
          - cifmw_fdp_update_container_images_repo_baseurl is defined
          - cifmw_fdp_update_container_images_repo_baseurl | length > 0
        fail_msg: |
          Required variables are missing!

          You must set:
            - cifmw_fdp_update_container_images_target_package: Name of the RPM package to update
            - cifmw_fdp_update_container_images_repo_baseurl: Repository base URL containing the updated package

          Example:
            ansible-playbook playbooks/fdp_update.yml \
              -e cifmw_fdp_update_container_images_target_package=ovn24.03 \
              -e cifmw_fdp_update_container_images_repo_baseurl=http://example.com/repo/
        success_msg: "Required variables validated successfully"

    - name: Display update configuration
      ansible.builtin.debug:
        msg:
          - "=============================================="
          - "OpenStack Package Update Configuration"
          - "=============================================="
          - "Target Package: {{ cifmw_fdp_update_container_images_target_package }}"
          - "Repository: {{ cifmw_fdp_update_container_images_repo_baseurl }}"
          - ""
          - "Update Control Flags:"
          - "  Control Plane Images: {{ cifmw_fdp_update_container_images_update_control_plane_images | default(true) }}"
          - "  EDPM Container Images: {{ cifmw_fdp_update_container_images_update_edpm_images | default(true) }}"
          - "  EDPM Host Packages: {{ cifmw_fdp_update_container_images_update_edpm_host_packages | default(true) }}"
          - ""
          - "Namespace: {{ cifmw_fdp_update_container_images_namespace | default('openstack') }}"
          - "=============================================="

    - name: Setup hypervisor firewall for registry access
      become: true
      when: cifmw_fdp_update_setup_hypervisor_firewall | default(true) | bool
      block:
        - name: Allow traffic from osp_trunk to ocpbm (compute -> registry)
          ansible.builtin.command: # noqa: command-instead-of-module
            cmd: iptables -I FORWARD -i osp_trunk -o ocpbm -j ACCEPT
          register: _fdp_update_fw_rule1
          failed_when: false
          changed_when: _fdp_update_fw_rule1.rc == 0

        - name: Allow return traffic from ocpbm to osp_trunk (registry -> compute)
          ansible.builtin.command: # noqa: command-instead-of-module
            cmd: iptables -I FORWARD -i ocpbm -o osp_trunk -m state --state RELATED,ESTABLISHED -j ACCEPT
          register: _fdp_update_fw_rule2
          failed_when: false
          changed_when: _fdp_update_fw_rule2.rc == 0

        - name: Persist firewall rules
          ansible.builtin.shell: # noqa: command-instead-of-shell
            cmd: iptables-save > /etc/sysconfig/iptables
          when: _fdp_update_fw_rule1.changed or _fdp_update_fw_rule2.changed

  roles:
    # Update control plane container images
    - role: fdp_update_container_images
      when: cifmw_fdp_update_container_images_update_control_plane_images | default(true) | bool

    # Update EDPM (containers and host packages unified)
    - role: fdp_update_edpm
      vars:
        # Map old variables to new unified role
        cifmw_fdp_update_edpm_namespace: "{{ cifmw_fdp_update_container_images_namespace | default('openstack') }}"
        cifmw_fdp_update_edpm_repo_baseurl: "{{ cifmw_fdp_update_container_images_repo_baseurl }}"
        cifmw_fdp_update_edpm_containers_enabled: "{{ cifmw_fdp_update_container_images_update_edpm_images | default(true) | bool }}"
        cifmw_fdp_update_edpm_packages_enabled: "{{ cifmw_fdp_update_container_images_update_edpm_host_packages | default(true) | bool }}"
      when: >-
        (cifmw_fdp_update_container_images_update_edpm_images | default(true) | bool) or
        (cifmw_fdp_update_container_images_update_edpm_host_packages | default(true) | bool)

  post_tasks:
    - name: Build status messages
      ansible.builtin.set_fact:
        _upic_cp_status: "{{ 'Updated' if (cifmw_fdp_update_container_images_update_control_plane_images | default(true) | bool) else 'Skipped' }}"
        _upic_edpm_images_status: "{{ 'Updated' if (cifmw_fdp_update_container_images_update_edpm_images | default(true) | bool) else 'Skipped' }}"
        _upic_edpm_packages_status: "{{ 'Service created' if (cifmw_fdp_update_container_images_update_edpm_host_packages | default(true) | bool) else 'Skipped' }}"
        _upic_edpm_enabled: "{{ (cifmw_fdp_update_container_images_update_edpm_images | default(true) | bool) or (cifmw_fdp_update_container_images_update_edpm_host_packages | default(true) | bool) }}"

    - name: Display completion summary
      ansible.builtin.debug:
        msg:
          - "=============================================="
          - "OpenStack Package Update Completed"
          - "=============================================="
          - ""
          - "Control plane containers: {{ _upic_cp_status }}"
          - "EDPM container images: {{ _upic_edpm_images_status }}"
          - "EDPM host packages: {{ _upic_edpm_packages_status }}"
          - ""
          - "Package: {{ cifmw_fdp_update_container_images_target_package }}"
          - "Repository: {{ cifmw_fdp_update_container_images_repo_baseurl }}"
          - "Namespace: {{ cifmw_fdp_update_edpm_containers_namespace | default('openstack') }}"
          - "=============================================="
