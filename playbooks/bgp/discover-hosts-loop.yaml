---
- name: BGP discover hosts
  hosts: controller-0
  gather_facts: true
  tasks:
    - name: Wait for expected number of discovered hypervisor
      vars:
        num_computes: >-
          {{
            groups['r0-computes'] | length +
            groups['r1-computes'] | length +
            groups['r2-computes'] | length
          }}
      ansible.builtin.shell:
        cmd: >
          oc rsh -n openstack nova-cell0-conductor-0 nova-manage cell_v2 discover_hosts > /dev/null &&
          oc -n openstack rsh openstackclient openstack hypervisor list -f value -c State
      register: hv_result
      changed_when: false
      retries: 50
      delay: 2
      until:
        - hv_result.rc == 0
        - hv_result.stdout_lines == ["up"] * (num_computes | int)
