---
- name: Add lunaclient to inventory
  hosts: "{{ cifmw_target_hook_host | default('localhost') }}"
  tasks:
    - name: Get lunaclient key
      ansible.builtin.get_url:
        url: "{{ cifmw_hsm_lunaclient_key }}"
        dest: "{{ ansible_user_dir }}/.ssh/lunaclient"
        mode: "0400"
    - name: Add lunaclient VM to inventory
      ansible.builtin.add_host:
        name: "{{ cifmw_hsm_lunaclient_vm }}"
        ansible_user: "{{ cifmw_hsm_lunaclient_user }}"
        ansible_ssh_private_key_file: "{{ ansible_user_dir }}/.ssh/lunaclient"
        ansible_ssh_common_args: "-o StrictHostKeyChecking=no"

- name: Create modified barbican image and get secrets
  hosts: "{{ cifmw_hsm_lunaclient_vm }}"
  tasks:
    - name: Include hsm_prep role
      ansible.builtin.include_role:
        name: hsm_prep
      vars:
        cifmw_hsm_client_ip: "{{ hostvars[ cifmw_hsm_client_machine ].ansible_host }}"

- name: Create kustomization to use update barbican to use luna
  hosts: "{{ cifmw_target_hook_host | default('localhost') }}"
  tasks:
    - name: Create file to customize barbican resource deployed in the control plane
      vars:
        certs_secret: "{{ cifmw_hsm_luna_cert_secret | default('barbican-luna-certs', true) }}"
        login_secret: "{{ cifmw_hsm_login_secret | default('hsm-login', true) }}"
        cifmw_hsm_client_ip: "{{ hostvars[ cifmw_hsm_client_machine ].ansible_host }}"
      ansible.builtin.copy:
        dest: "{{ cifmw_basedir }}/artifacts/manifests/kustomizations/controlplane/93-barbican-luna.yaml"
        content: |-
          apiVersion: kustomize.config.k8s.io/v1beta1
          kind: Kustomization
          resources:
          namespace: {{ namespace }}
          patches:
          - target:
              kind: OpenStackControlPlane
              name: .*
            patch: |-
              - op: add
                path: /spec/barbican/template/globalDefaultSecretStore
                value: pkcs11
              - op: add
                path: /spec/barbican/template/enabledSecretStores
                value:
                  - pkcs11
              - op: add
                path: /spec/barbican/template/pkcs11
                value:
                  type: luna
                  libraryPath: /usr/local/luna/libs/64/libCryptoki2.so
                  tokenLabels: "{{ cifmw_hsm_luna_partition }}"
                  MKEKLabel: "{{ cifm_hsm_mkek_label }}"
                  HMACLabel: "{{ cifm_hsm_hmac_label }}"
                  serverAddress: "{{ cifmw_hsm_server_ip }}"
                  clientAddress: "{{ cifmw_hsm_client_ip }}"
                  loginSecret: "{{ login_secret }}"
                  certificatesSecret: "{{ certs_secret }}"
                  certificatesMountPoint: /usr/local/luna/config/certs
                  keyWrapMechanism: "{{ cifmw_hsm_key_wrap_mechanism }}"
