---
# Copyright Red Hat, Inc.
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

- name: OSP 17 - Multi-stack post overcloud
  hosts: "{{ cifmw_target_host | default('localhost') }}"
  vars:
    _ansible_user_dir: "{{ ansible_user_dir | default('/home/zuul') }}"
  tasks:
    - name: Manage cells
      delegate_to: osp-undercloud-0
      environment:
        ANSIBLE_HOST_KEY_CHECKING: "False"
        ANSIBLE_SSH_RETRIES: "3"
        ANSIBLE_REMOTE_USER: tripleo-admin
        OS_CLOUD: overcloud
      ansible.builtin.shell: |
        set -eu
        ansible allovercloud \
          -i {{ _ansible_user_dir }}/inventories -m include_role \
          -a name=tripleo_hosts_entries \
          -e tripleo_stack_name=all \
          -e role_networks='["InternalApi"]' \
          -e hostname_resolve_network=ctlplane -e plan=overcloud \
          -e @{{ _ansible_user_dir }}/overcloud-deploy/overcloud/config-download/overcloud/global_vars.yaml
