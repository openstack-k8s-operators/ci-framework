---
- name: Prepare custom CA secret
  hosts: "{{ cifmw_target_hook_host | default('localhost') }}"
  gather_facts: false
  connection: local
  vars:
    _custom_ca_cert_filepath: "{{ custom_ca_cert_filepath | default('/tmp/ca_cert.txt') }}"
    _namespace: "{{ namespace | default('openstack') }}"
  tasks:
    - name: Download cert
      ansible.builtin.get_url:
        url: "{{ custom_ca_cert_url }}"
        dest: "{{ _custom_ca_cert_filepath }}"
        mode: '0644'
      when: custom_ca_cert_url is defined
      register: download_status
      until: download_status is not failed and (download_status.status_code is undefined or download_status.status_code == 200)
      retries: 10
      delay: 5

    - name: Read custom CA certificate file
      ansible.builtin.slurp:
        src: "{{ _custom_ca_cert_filepath }}"
      register: custom_ca_certs

    - name: Create custom CA secret
      kubernetes.core.k8s:
        kubeconfig: "{{ cifmw_openshift_kubeconfig }}"
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          type: Opaque
          metadata:
            name: custom-ca-certs
            namespace: "{{ _namespace }}"
          data:
            CustomCACerts: "{{ custom_ca_certs.content }}"
