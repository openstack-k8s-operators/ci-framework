---
- name: Add lunaclient to inventory
  hosts: "{{ cifmw_target_hook_host | default('localhost') }}"
  tasks:
    - name: Get lunaclient key
      ansible.builtin.get_url:
        url: "{{ cifmw_hsm_lunaclient_key }}"
        dest: "{{ ansible_user_dir }}/.ssh/lunaclient"
        mode: "0400"
    - name: Add lunaclient VM to inventory
      ansible.builtin.add_host:
        name: "{{ cifmw_hsm_lunaclient_vm }}"
        ansible_user: "{{ cifmw_hsm_lunaclient_user }}"
        ansible_ssh_private_key_file: "{{ ansible_user_dir }}/.ssh/lunaclient"
        ansible_ssh_common_args: "-o StrictHostKeyChecking=no"

- name: Create and store modified barbican images
  hosts: "{{ cifmw_hsm_lunaclient_vm }}"
  tasks:
    - name: Include hsm_prep role cleanup tasks
      ansible.builtin.include_role:
        name: hsm_prep
        tasks_from: cleanup.yml
      vars:
        cifmw_hsm_client_ip: "{{ hostvars[ cifmw_hsm_client_machine ].ansible_host }}"
