---
- name: Create kustomization to update Horizon to use Federation
  hosts: "{{ cifmw_target_hook_host | default('localhost') }}"
  tasks:
    - name: Read uni vars from federation role
      ansible.builtin.set_fact:
        cifmw_federation_domain: "apps.ocp.openstack.lab"
      when: cifmw_federation_deploy_type == "uni"

    - name: Read crc vars from federation role
      ansible.builtin.set_fact:
        cifmw_federation_domain: "apps-crc.testing"
      when: cifmw_federation_deploy_type == "crc"

    - name: Read all vars from federation role
      ansible.builtin.import_role:
        name: federation
        vars_from: all-vars.yml

    - name: Set websso settings for single IdP
      ansible.builtin.set_fact:
        cifmw_federation_websso_choices: '("OIDC", _("OpenID Connect")),'
        cifmw_federation_websso_idp_mapping: '"OIDC": ("{{ cifmw_federation_IdpName }}", "openid"),'

    - name: Set websso settings for multiple IdP
      ansible.builtin.set_fact:
        cifmw_federation_websso_choices: '("OIDC1", _("OpenID Connect IdP1")),("OIDC2", _("OpenID Connect IdP2")),'
        cifmw_federation_websso_idp_mapping: '"OIDC1": ("{{ cifmw_federation_IdpName }}", "openid"),"OIDC2": ("{{ cifmw_federation_IdpName2 }}", "openid"),'
      when: cifmw_federation_deploy_multirealm is true

    - name: Create file to customize horizon for Federation resources deployed in the control plane
      ansible.builtin.copy:
        dest: "{{ cifmw_basedir }}/artifacts/manifests/kustomizations/controlplane/horizon_federation.yaml"
        mode: preserve
        content: |-
          apiVersion: kustomize.config.k8s.io/v1beta1
          kind: Kustomization
          resources:
          - namespace: {{ namespace }}
          patches:
          - target:
              kind: OpenStackControlPlane
              name: .*
            patch: |-
              - op: add
                path: /spec/horizon/enabled
                value: true
              - op: add
                path: /spec/horizon/template/memcachedInstance
                value: memcached
              - op: add
                path: /spec/horizon/template/customServiceConfig
                value: |
                  OPENSTACK_KEYSTONE_URL = "{{ cifmw_federation_keystone_url }}/v3"
                  WEBSSO_ENABLED = True
                  WEBSSO_CHOICES = (
                    ("credentials", _("Keystone Credentials")),
                    {{ cifmw_federation_websso_choices }}
                  )
                  WEBSSO_IDP_MAPPING = {
                    {{ cifmw_federation_websso_idp_mapping }}
                  }
