---
- name: Kustomize ControlPlane for ironic service
  hosts: "{{ cifmw_target_hook_host | default('localhost') }}"
  gather_facts: false
  tasks:
    - name: Ensure the kustomizations dir exists
      ansible.builtin.file:
        path: "{{ cifmw_basedir }}/artifacts/manifests/kustomizations/controlplane"
        state: directory
        mode: "0755"

    - name: Create kustomization to enable ironic
      ansible.builtin.copy:
        dest: "{{ cifmw_basedir }}/artifacts/manifests/kustomizations/controlplane/98-ironic-kustomization.yaml"
        content: |-
          apiVersion: kustomize.config.k8s.io/v1beta1
          kind: Kustomization
          resources:
          namespace: {{ namespace }}
          patches:
          - target:
              kind: OpenStackControlPlane
            patch: |-
              - op: add
                path: /spec/swift/enabled
                value: false
              - op: add
                path: /spec/barbican/enabled
                value: false
              - op: add
                path: /spec/telemetry/enabled
                value: false
              - op: add
                path: /spec/ironic/enabled
                value: {{ cifmw_services_ironic_enabled | default('false') }}
              - op: add
                path: /spec/ironic/template/rpcTransport
                value: oslo
              - op: add
                path: /spec/ironic/template/ironicAPI/override
                value:
                  service:
                    internal:
                      metadata:
                        annotations:
                          metallb.universe.tf/address-pool: internalapi
                          metallb.universe.tf/allow-shared-ip: internalapi
                          metallb.universe.tf/loadBalancerIPs: 172.17.0.80
                      spec:
                        type: LoadBalancer
              - op: add
                path: /spec/ironic/template/ironicConductors/0/networkAttachments
                value:
                  - baremetal
              - op: add
                path: /spec/ironic/template/ironicConductors/0/provisionNetwork
                value: baremetal
              - op: add
                path: /spec/ironic/template/ironicConductors/0/customServiceConfig
                value: |
                  [neutron]
                  cleaning_network = provisioning
                  provisioning_network = provisioning
                  rescuing_network = provisioning
              - op: add
                path: /spec/ironic/template/ironicInspector/networkAttachments
                value:
                  - baremetal
              - op: add
                path: /spec/ovn/template/ovnController/nicMappings
                value:
                  baremetal: baremetal
              - op: add
                path: /spec/nova/cellTemplates
                value:
                  cell0:
                    cellDatabaseUser: nova_cell0
                    hasAPIAccess: true
                  cell1:
                    cellDatabaseUser: nova_cell1
                    cellDatabaseInstance: openstack-cell1
                    cellMessageBusInstance: rabbitmq-cell1
                    hasAPIAccess: true
                    novaComputeTemplates:
                      compute-ironic:
                        computeDriver: ironic.IronicDriver

        mode: "0644"
